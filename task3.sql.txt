CREATE DATABASE IF NOT EXISTS elevate_task3;
USE elevate_task3;

CREATE TABLE IF NOT EXISTS users (
  user_id INT PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(150),
  signup_date DATE
);

CREATE TABLE IF NOT EXISTS products (
  product_id INT PRIMARY KEY,
  name VARCHAR(200),
  category VARCHAR(100),
  price DECIMAL(10,2)
);

CREATE TABLE IF NOT EXISTS orders (
  order_id INT PRIMARY KEY,
  user_id INT,
  order_date DATE,
  total_amount DECIMAL(10,2),
  status VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS order_items (
  order_item_id INT PRIMARY KEY,
  order_id INT,
  product_id INT,
  quantity INT,
  price DECIMAL(10,2)
);

CREATE TABLE IF NOT EXISTS reviews (
  review_id INT PRIMARY KEY,
  user_id INT,
  product_id INT,
  rating INT,
  review_date DATE
);

INSERT IGNORE INTO users VALUES
(1, 'Harsha', 'harsha@gmail.com', '2024-01-05'),
(2, 'Manoj', 'manoj@gmail.com', '2024-02-10'),
(3, 'Sita', 'sita@gmail.com', '2024-03-15');

INSERT IGNORE INTO products VALUES
(101, 'Laptop', 'Electronics', 49900.00),
(102, 'Headphones', 'Accessories', 1999.00),
(103, 'Phone Case', 'Accessories', 199.00),
(104, 'Laptop Bag', 'Accessories', 899.00);

INSERT IGNORE INTO orders VALUES
(1001, 1, '2024-04-05', 499.00, 'completed'),
(1002, 2, '2024-04-12', 1298.00, 'completed'),
(1003, 3, '2024-05-10', 199.00, 'completed');

INSERT IGNORE INTO order_items VALUES
(1, 1001, 101, 1, 499.00),
(2, 1002, 103, 1, 899.00),
(3, 1002, 102, 2, 199.00),
(4, 1003, 102, 1, 199.00);

INSERT IGNORE INTO reviews VALUES
(1, 1, 101, 5, '2024-04-06'),
(2, 2, 103, 4, '2024-04-13'),
(3, 3, 102, 3, '2024-05-12');

SELECT SUM(total_amount) / NULLIF(COUNT(DISTINCT user_id),0) AS arpu
FROM orders
WHERE status='completed';

SELECT AVG(user_total) AS arpu_by_user
FROM (
  SELECT user_id, SUM(total_amount) AS user_total
  FROM orders
  WHERE status='completed'
  GROUP BY user_id
) t;

DROP VIEW IF EXISTS monthly_revenue;
CREATE VIEW monthly_revenue AS
SELECT DATE_FORMAT(order_date,'%Y-%m') AS month,
       COUNT(*) AS orders_count,
       SUM(total_amount) AS revenue
FROM orders
WHERE status='completed'
GROUP BY month;

SELECT * FROM monthly_revenue;

SELECT p.product_id, p.name, p.category, SUM(oi.quantity) AS total_qty
FROM order_items oi
JOIN products p ON p.product_id = oi.product_id
GROUP BY p.product_id, p.name, p.category
ORDER BY total_qty DESC
LIMIT 10;

SELECT u.user_id, u.name, SUM(o.total_amount) AS total_spent
FROM orders o
JOIN users u ON u.user_id = o.user_id
WHERE o.status='completed'
GROUP BY u.user_id, u.name
ORDER BY total_spent DESC
LIMIT 10;

SELECT COUNT(rating) AS non_null_ratings, COUNT(*) AS total_reviews
FROM reviews;

SELECT order_id, IFNULL(total_amount,0) AS total_amount_safe
FROM orders;

SELECT o.order_id, o.order_date, o.total_amount, u.user_id, u.name
FROM orders o
JOIN users u ON u.user_id = o.user_id
ORDER BY o.order_date DESC;

SELECT u.user_id, u.name,
       (SELECT MAX(o.order_date) FROM orders o WHERE o.user_id = u.user_id) AS last_order_date
FROM users u;

DROP VIEW IF EXISTS top_kpi;
CREATE VIEW top_kpi AS
SELECT
  (SELECT SUM(total_amount) FROM orders WHERE status='completed') AS total_revenue,
  (SELECT COUNT(DISTINCT user_id) FROM orders WHERE status='completed') AS buyer_count,
  (SELECT SUM(total_amount)/NULLIF(COUNT(DISTINCT user_id),0) FROM orders WHERE status='completed') AS arpu_value;

SELECT * FROM top_kpi;

CREATE INDEX idx_orders_userid ON orders(user_id);
CREATE INDEX idx_orderitems_productid ON order_items(product_id);
CREATE INDEX idx_orders_orderdate ON orders(order_date);
